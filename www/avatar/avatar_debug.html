<!DOCTYPE html>
<html>
<head>
    <title>ZeroAI Avatar Debug Console - Complete</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #1a1a1a; color: #fff; }
        .container { max-width: 1400px; margin: 0 auto; }
        .section { background: #2a2a2a; padding: 20px; margin: 20px 0; border-radius: 8px; }
        .option-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; margin: 15px 0; }
        .option-group { background: #333; padding: 15px; border-radius: 6px; }
        .option-group h4 { margin: 0 0 10px 0; color: #4CAF50; }
        .controls { display: flex; gap: 10px; margin: 10px 0; flex-wrap: wrap; align-items: center; }
        .control-group { display: flex; align-items: center; gap: 8px; margin: 5px 0; }
        button { padding: 10px 20px; background: #007cba; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #005a87; }
        button.danger { background: #dc3545; }
        button.success { background: #28a745; }
        input, select, textarea { background: #333; color: #fff; border: 1px solid #555; padding: 8px; border-radius: 4px; }
        input[type="file"] { padding: 3px; }
        input[type="range"] { width: 150px; }
        input[type="number"] { width: 80px; }
        input[type="checkbox"] { width: auto; margin-right: 5px; }
        textarea { width: 100%; height: 100px; resize: vertical; }
        .log-container { background: #000; color: #0f0; font-family: monospace; padding: 15px; height: 300px; overflow-y: auto; border: 1px solid #333; }
        .status-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; }
        .status-item { background: #333; padding: 15px; border-radius: 4px; }
        .status-ok { border-left: 4px solid #28a745; }
        .status-error { border-left: 4px solid #dc3545; }
        .status-warning { border-left: 4px solid #ffc107; }
        video { width: 100%; max-width: 500px; border: 2px solid #555; }
        .debug-info { background: #1a1a2e; padding: 10px; margin: 10px 0; border-radius: 4px; font-family: monospace; font-size: 12px; }
        .loading { display: none; color: #ffc107; }
        .error { color: #dc3545; }
        .success { color: #28a745; }
        .image-preview { max-width: 200px; max-height: 200px; border: 2px solid #555; margin: 10px 0; }
        .tabs { display: flex; background: #333; border-radius: 6px 6px 0 0; overflow: hidden; }
        .tab { padding: 12px 20px; cursor: pointer; background: #444; border-right: 1px solid #555; }
        .tab.active { background: #007cba; }
        .tab-content { display: none; background: #333; padding: 20px; border-radius: 0 0 6px 6px; }
        .tab-content.active { display: block; }
        label { display: inline-block; min-width: 120px; color: #ccc; }
        .range-display { color: #4CAF50; font-weight: bold; margin-left: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ü§ñ ZeroAI Avatar Debug Console - Complete Edition</h1>

        <div class="section">
            <h2>Avatar Generation with All Options</h2>

            <!-- Mode Selection -->
            <div class="control-group">
                <label><strong>Generation Mode:</strong></label>
                <input type="radio" id="mode-simple" name="mode" value="simple" checked>
                <label for="mode-simple">Simple Avatar</label>
                <input type="radio" id="mode-sadtalker" name="mode" value="sadtalker">
                <label for="mode-sadtalker">SadTalker (Realistic)</label>
            </div>

            <!-- Stream Mode -->
            <div class="control-group">
                <label for="streamMode"><strong>Stream Mode:</strong></label>
                <select id="streamMode">
                    <option value="complete">Complete (Full video)</option>
                    <option value="chunked">Chunked Streaming</option>
                    <option value="realtime">Realtime Streaming</option>
                </select>
            </div>

            <!-- Prompt -->
            <div style="margin: 15px 0;">
                <label for="prompt"><strong>Prompt:</strong></label>
                <textarea id="prompt" placeholder="Enter your prompt here...">Hello! This is a comprehensive test of the avatar system with all available options enabled.</textarea>
            </div>

            <!-- Tabbed Options -->
            <div class="tabs">
                <div class="tab active" onclick="switchTab('tts')">üéôÔ∏è TTS Options</div>
                <div class="tab" onclick="switchTab('image')">üñºÔ∏è Image Options</div>
                <div class="tab" onclick="switchTab('video')">üé¨ Video Options</div>
                <div class="tab" onclick="switchTab('sadtalker')">üé≠ SadTalker Options</div>
                <div class="tab" onclick="switchTab('advanced')">‚öôÔ∏è Advanced Options</div>
            </div>

            <!-- TTS Options Tab -->
            <div id="tts-tab" class="tab-content active">
                <div class="option-grid">
                    <div class="option-group">
                        <h4>TTS Engine & Voice</h4>
                        <div class="control-group">
                            <label for="ttsEngine">Engine:</label>
                            <select id="ttsEngine" onchange="updateTTSOptions()">
                                <option value="espeak">eSpeak (Free)</option>
                                <option value="edge">Microsoft Edge TTS</option>
                                <option value="elevenlabs">ElevenLabs (Premium)</option>
                                <option value="openai">OpenAI TTS</option>
                                <option value="coqui">Coqui TTS</option>
                            </select>
                        </div>
                        <div class="control-group" id="voiceGroup">
                            <label for="ttsVoice">Voice:</label>
                            <select id="ttsVoice"></select>
                        </div>
                        <div class="control-group">
                            <label for="ttsLanguage">Language:</label>
                            <select id="ttsLanguage">
                                <option value="en-US">English (US)</option>
                                <option value="en-GB">English (UK)</option>
                                <option value="es-ES">Spanish</option>
                                <option value="fr-FR">French</option>
                                <option value="de-DE">German</option>
                            </select>
                        </div>
                    </div>

                    <div class="option-group">
                        <h4>Voice Parameters</h4>
                        <div class="control-group">
                            <label for="ttsSpeed">Speed:</label>
                            <input type="range" id="ttsSpeed" min="50" max="400" value="160" oninput="updateRangeDisplay('speed', this.value)">
                            <span id="speedDisplay" class="range-display">160</span>
                        </div>
                        <div class="control-group">
                            <label for="ttsPitch">Pitch:</label>
                            <input type="range" id="ttsPitch" min="-50" max="50" value="0" oninput="updateRangeDisplay('pitch', this.value)">
                            <span id="pitchDisplay" class="range-display">0</span>
                        </div>
                        <div class="control-group">
                            <label for="ttsEmotion">Emotion:</label>
                            <select id="ttsEmotion">
                                <option value="neutral">Neutral</option>
                                <option value="happy">Happy</option>
                                <option value="sad">Sad</option>
                                <option value="angry">Angry</option>
                                <option value="excited">Excited</option>
                            </select>
                        </div>
                    </div>

                    <div class="option-group">
                        <h4>Audio Format</h4>
                        <div class="control-group">
                            <label for="sampleRate">Sample Rate:</label>
                            <select id="sampleRate">
                                <option value="16000">16kHz</option>
                                <option value="22050">22kHz</option>
                                <option value="44100">44kHz</option>
                                <option value="48000">48kHz</option>
                            </select>
                        </div>
                        <div class="control-group">
                            <label for="audioFormat">Format:</label>
                            <select id="audioFormat">
                                <option value="wav">WAV</option>
                                <option value="mp3">MP3</option>
                                <option value="ogg">OGG</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Image Options Tab -->
            <div id="image-tab" class="tab-content">
                <div class="option-grid">
                    <div class="option-group">
                        <h4>Image Source</h4>
                        <div class="control-group">
                            <input type="radio" id="imageDefault" name="imageSource" value="default" checked onchange="toggleImageSource()">
                            <label for="imageDefault">Use Default Face</label>
                        </div>
                        <div class="control-group">
                            <input type="radio" id="imageUpload" name="imageSource" value="upload" onchange="toggleImageSource()">
                            <label for="imageUpload">Upload Image</label>
                        </div>
                        <div class="control-group">
                            <input type="radio" id="imageUrl" name="imageSource" value="url" onchange="toggleImageSource()">
                            <label for="imageUrl">Image URL</label>
                        </div>

                        <div id="uploadSection" style="display: none; margin-top: 10px;">
                            <input type="file" id="imageFile" accept="image/*" onchange="handleImageUpload(event)">
                            <div id="imagePreview"></div>
                        </div>

                        <div id="urlSection" style="display: none; margin-top: 10px;">
                            <input type="url" id="imageUrlInput" placeholder="https://example.com/image.jpg" style="width: 100%;">
                            <button onclick="previewImageUrl()" style="margin-top: 5px;">Preview</button>
                        </div>
                    </div>

                    <div class="option-group">
                        <h4>Image Processing</h4>
                        <div class="control-group">
                            <label for="preprocess">Preprocessing:</label>
                            <select id="preprocess">
                                <option value="crop">Crop</option>
                                <option value="resize">Resize</option>
                                <option value="none">None</option>
                            </select>
                        </div>
                        <div class="control-group">
                            <label for="resolution">Resolution:</label>
                            <select id="resolution">
                                <option value="256">256x256</option>
                                <option value="512">512x512</option>
                                <option value="1024">1024x1024</option>
                            </select>
                        </div>
                        <div class="control-group">
                            <input type="checkbox" id="still">
                            <label for="still">Still Image (no motion source)</label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Video Options Tab -->
            <div id="video-tab" class="tab-content">
                <div class="option-grid">
                    <div class="option-group">
                        <h4>Video Codec & Quality</h4>
                        <div class="control-group">
                            <label for="codec">Codec:</label>
                            <select id="codec">
                                <option value="h264_high">H264 High Quality</option>
                                <option value="h264_medium">H264 Medium</option>
                                <option value="h264_fast" selected>H264 Fast</option>
                                <option value="h265_high">H265 High Quality</option>
                                <option value="webm_high">WebM High Quality</option>
                                <option value="webm_fast">WebM Fast</option>
                            </select>
                        </div>
                        <div class="control-group">
                            <label for="quality">Quality:</label>
                            <select id="quality">
                                <option value="high">High</option>
                                <option value="medium" selected>Medium</option>
                                <option value="fast">Fast</option>
                            </select>
                        </div>
                        <div class="control-group">
                            <label for="fps">Frame Rate:</label>
                            <select id="fps">
                                <option value="15">15 FPS</option>
                                <option value="20">20 FPS</option>
                                <option value="24">24 FPS</option>
                                <option value="25" selected>25 FPS</option>
                                <option value="30">30 FPS</option>
                            </select>
                        </div>
                    </div>

                    <div class="option-group">
                        <h4>Streaming Options</h4>
                        <div class="control-group">
                            <label for="chunkDuration">Chunk Duration:</label>
                            <input type="number" id="chunkDuration" min="1" max="10" value="3" step="0.5">
                            <span>seconds</span>
                        </div>
                        <div class="control-group">
                            <label for="bufferSize">Buffer Size:</label>
                            <input type="number" id="bufferSize" min="1" max="20" value="5">
                            <span>frames</span>
                        </div>
                        <div class="control-group">
                            <input type="checkbox" id="lowLatency">
                            <label for="lowLatency">Low Latency Mode</label>
                        </div>
                        <div class="control-group">
                            <input type="checkbox" id="adaptiveQuality" checked>
                            <label for="adaptiveQuality">Adaptive Quality</label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SadTalker Options Tab -->
            <div id="sadtalker-tab" class="tab-content">
                <div class="option-grid">
                    <div class="option-group">
                        <h4>Generation Settings</h4>
                        <div class="control-group">
                            <label for="timeout">Timeout:</label>
                            <input type="number" id="timeout" min="60" max="3600" value="1200">
                            <span>seconds</span>
                        </div>
                        <div class="control-group">
                            <label for="enhancer">Enhancer:</label>
                            <select id="enhancer">
                                <option value="">None</option>
                                <option value="gfpgan">GFPGAN</option>
                                <option value="restoreformer">RestoreFormer</option>
                            </select>
                        </div>
                    </div>

                    <div class="option-group">
                        <h4>Chunking Options</h4>
                        <div class="control-group">
                            <input type="checkbox" id="splitChunks">
                            <label for="splitChunks">Split into Chunks</label>
                        </div>
                        <div class="control-group">
                            <label for="chunkLength">Chunk Length:</label>
                            <input type="number" id="chunkLength" min="5" max="30" value="10">
                            <span>seconds</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Advanced Options Tab -->
            <div id="advanced-tab" class="tab-content">
                <div class="option-grid">
                    <div class="option-group">
                        <h4>Performance</h4>
                        <div class="control-group">
                            <label for="maxDuration">Max Duration:</label>
                            <input type="number" id="maxDuration" min="10" max="600" value="300">
                            <span>seconds</span>
                        </div>
                        <div class="control-group">
                            <label for="maxConcurrent">Max Concurrent:</label>
                            <input type="number" id="maxConcurrent" min="1" max="10" value="3">
                        </div>
                        <div class="control-group">
                            <input type="checkbox" id="enableWebsocket">
                            <label for="enableWebsocket">Enable WebSocket</label>
                        </div>
                    </div>

                    <div class="option-group">
                        <h4>Debug Options</h4>
                        <div class="control-group">
                            <input type="checkbox" id="debugMode" checked>
                            <label for="debugMode">Debug Mode</label>
                        </div>
                        <div class="control-group">
                            <input type="checkbox" id="verboseLogging">
                            <label for="verboseLogging">Verbose Logging</label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="controls" style="margin-top: 20px;">
                <button onclick="generateAvatar()" style="background: #28a745; font-size: 16px; padding: 12px 24px;">üöÄ Generate Avatar</button>
                <button onclick="testMP4()" class="success">Test MP4 Pipeline</button>
                <button onclick="testConnection()" class="success">Test Connection</button>
                <button onclick="getEngines()">Get TTS Engines</button>
                <button onclick="getStatus()">Get Status</button>
                <button onclick="getLogs()">Get Logs</button>
                <button onclick="clearLogs()" class="danger">Clear Logs</button>
            </div>

            <div class="loading" id="loading">
                <p>üîÑ Generating avatar... This may take a few minutes.</p>
                <div id="progress"></div>
            </div>

            <div id="result" style="display: none;">
                <h3>Generated Avatar:</h3>
                <video id="avatarVideo" controls>
                    Your browser does not support the video tag.
                </video>
                <div class="debug-info" id="videoInfo"></div>
            </div>

            <div id="error" class="error" style="display: none;"></div>
        </div>

        <!-- Status and Logs sections remain the same -->
        <div class="section">
            <h2>Server Connection</h2>
            <div class="controls">
                <button onclick="getServerInfo()">Get Server Info</button>
            </div>
            <div class="status-grid" id="serverInfo">
                <div class="status-item">Click "Get Server Info" to see which avatar server is being used...</div>
            </div>
        </div>

        <div class="section">
            <h2>System Status</h2>
            <div class="controls">
                <button onclick="refreshStatus()">Refresh Status</button>
            </div>
            <div class="status-grid" id="statusGrid">
                <div class="status-item">Loading status...</div>
            </div>
        </div>

        <div class="section">
            <h2>Debug Logs</h2>
            <div class="controls">
                <button onclick="refreshLogs()">Refresh Logs</button>
                <button onclick="clearDebugLogs()" class="danger">Clear Debug Logs</button>
                <button onclick="downloadLogs()">Download Logs</button>
                <button onclick="copyLogsToClipboard()">Copy to Clipboard</button>
            </div>
            <div class="log-container" id="logContainer">
                Click "Refresh Logs" to load debug information...
            </div>
        </div>
    </div>

    <script>
        let debugMode = true;
        let currentMode = 'simple';
        let currentImageData = null;

        // TTS Engine configurations
        const TTS_ENGINES = {
            espeak: {
                name: 'eSpeak (Free)',
                voices: [
                    { value: 'en', label: 'English (Default)' },
                    { value: 'en+f3', label: 'English Female 3' },
                    { value: 'en+f4', label: 'English Female 4' },
                    { value: 'en+m3', label: 'English Male 3' },
                    { value: 'en+m4', label: 'English Male 4' }
                ],
                speedRange: [80, 400],
                pitchRange: [0, 99]
            },
            edge: {
                name: 'Microsoft Edge TTS',
                voices: [
                    { value: 'en-US-AriaNeural', label: 'Aria (Female)' },
                    { value: 'en-US-JennyNeural', label: 'Jenny (Female)' },
                    { value: 'en-US-GuyNeural', label: 'Guy (Male)' },
                    { value: 'en-US-DavisNeural', label: 'Davis (Male)' },
                    { value: 'en-US-JaneNeural', label: 'Jane (Female)' },
                    { value: 'en-US-JasonNeural', label: 'Jason (Male)' }
                ],
                speedRange: [50, 300],
                pitchRange: [-50, 50]
            },
            elevenlabs: {
                name: 'ElevenLabs (Premium)',
                voices: [
                    { value: '21m00Tcm4TlvDq8ikWAM', label: 'Rachel (Female)' },
                    { value: 'AZnzlk1XvdvUeBnXmlld', label: 'Domi (Female)' },
                    { value: 'EXAVITQu4vr4xnSDxMaL', label: 'Bella (Female)' },
                    { value: 'ErXwobaYiN019PkySvjV', label: 'Antoni (Male)' },
                    { value: 'MF3mGyEYCl7XYWbV9V6O', label: 'Elli (Female)' },
                    { value: 'TxGEqnHWrfWFTfGW9XjX', label: 'Josh (Male)' }
                ],
                speedRange: [50, 200],
                pitchRange: [-100, 100]
            },
            openai: {
                name: 'OpenAI TTS',
                voices: [
                    { value: 'alloy', label: 'Alloy (Neutral)' },
                    { value: 'echo', label: 'Echo (Male)' },
                    { value: 'fable', label: 'Fable (British Male)' },
                    { value: 'onyx', label: 'Onyx (Male)' },
                    { value: 'nova', label: 'Nova (Female)' },
                    { value: 'shimmer', label: 'Shimmer (Female)' }
                ],
                speedRange: [25, 400],
                pitchRange: [0, 0]
            },
            coqui: {
                name: 'Coqui TTS',
                voices: [
                    { value: 'female', label: 'Female (Default)' },
                    { value: 'male', label: 'Male (Default)' }
                ],
                speedRange: [50, 200],
                pitchRange: [-50, 50]
            }
        };

        // Debug logging
        function debugLog(message, data = null) {
            const timestamp = new Date().toISOString();
            console.log(`[${timestamp}] ${message}`, data || '');

            if (debugMode) {
                const logEntry = `${timestamp}: ${message}${data ? ' - ' + JSON.stringify(data, null, 2) : ''}`;
                appendToLog('logContainer', logEntry);
            }
        }

        function appendToLog(containerId, message) {
            const container = document.getElementById(containerId);
            container.innerHTML += message + '\n';
            container.scrollTop = container.scrollHeight;
        }

        // Tab switching
        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Show selected tab
            document.getElementById(tabName + '-tab').classList.add('active');
            event.target.classList.add('active');
        }

        // Range display updates
        function updateRangeDisplay(type, value) {
            document.getElementById(type + 'Display').textContent = value;
        }

        // TTS Engine updates
        function updateTTSOptions() {
            const engine = document.getElementById('ttsEngine').value;
            const voiceSelect = document.getElementById('ttsVoice');
            const speedRange = document.getElementById('ttsSpeed');
            const pitchRange = document.getElementById('ttsPitch');

            if (TTS_ENGINES[engine]) {
                const config = TTS_ENGINES[engine];

                // Update voice options
                voiceSelect.innerHTML = config.voices
                    .map(v => `<option value="${v.value}">${v.label}</option>`)
                    .join('');

                // Update speed range
                speedRange.min = config.speedRange[0];
                speedRange.max = config.speedRange[1];
                speedRange.value = Math.floor((config.speedRange[0] + config.speedRange[1]) / 2);
                updateRangeDisplay('speed', speedRange.value);

                // Update pitch range
                pitchRange.min = config.pitchRange[0];
                pitchRange.max = config.pitchRange[1];
                pitchRange.value = 0;
                updateRangeDisplay('pitch', pitchRange.value);
            }
        }

        // Image handling
        function toggleImageSource() {
            const uploadSection = document.getElementById('uploadSection');
            const urlSection = document.getElementById('urlSection');
            const source = document.querySelector('input[name="imageSource"]:checked').value;

            uploadSection.style.display = source === 'upload' ? 'block' : 'none';
            urlSection.style.display = source === 'url' ? 'block' : 'none';

            if (source === 'default') {
                currentImageData = null;
            }
        }

        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    currentImageData = e.target.result;
                    displayImagePreview(currentImageData);
                    debugLog('Image uploaded', { size: file.size, type: file.type });
                };
                reader.readAsDataURL(file);
            }
        }

        function previewImageUrl() {
            const url = document.getElementById('imageUrlInput').value;
            if (url) {
                currentImageData = url;
                displayImagePreview(url);
                debugLog('Image URL set', { url });
            }
        }

        function displayImagePreview(src) {
            const preview = document.getElementById('imagePreview');
            preview.innerHTML = `<img src="${src}" class="image-preview" alt="Preview">`;
        }

        // Mode change handler
        document.querySelectorAll('input[name="mode"]').forEach(radio => {
            radio.addEventListener('change', function() {
                currentMode = this.value;
                debugLog('Mode changed', { mode: currentMode });
            });
        });

        // Main generation function
        async function generateAvatar() {
            const loading = document.getElementById('loading');
            const result = document.getElementById('result');
            const error = document.getElementById('error');
            const video = document.getElementById('avatarVideo');
            const videoInfo = document.getElementById('videoInfo');

            // Collect ALL options from the form
            const payload = {
                // Core settings
                prompt: document.getElementById('prompt').value,
                mode: currentMode,
                stream_mode: document.getElementById('streamMode').value,

                // TTS options
                tts_engine: document.getElementById('ttsEngine').value,
                tts_voice: document.getElementById('ttsVoice').value,
                tts_speed: parseInt(document.getElementById('ttsSpeed').value),
                tts_pitch: parseInt(document.getElementById('ttsPitch').value),
                tts_language: document.getElementById('ttsLanguage').value,
                tts_emotion: document.getElementById('ttsEmotion').value,

                // Audio format
                sample_rate: parseInt(document.getElementById('sampleRate').value),
                format: document.getElementById('audioFormat').value,

                // Image options
                image: currentImageData,
                still: document.getElementById('still').checked,
                preprocess: document.getElementById('preprocess').value,
                resolution: document.getElementById('resolution').value,

                // Video options
                codec: document.getElementById('codec').value,
                quality: document.getElementById('quality').value,
                fps: parseInt(document.getElementById('fps').value),

                // Streaming options
                chunk_duration: parseFloat(document.getElementById('chunkDuration').value),
                buffer_size: parseInt(document.getElementById('bufferSize').value),
                low_latency: document.getElementById('lowLatency').checked,
                adaptive_quality: document.getElementById('adaptiveQuality').checked,

                // SadTalker options
                timeout: parseInt(document.getElementById('timeout').value),
                enhancer: document.getElementById('enhancer').value || null,
                split_chunks: document.getElementById('splitChunks').checked,
                chunk_length: parseInt(document.getElementById('chunkLength').value),

                // Advanced options
                max_duration: parseInt(document.getElementById('maxDuration').value),
                max_concurrent: parseInt(document.getElementById('maxConcurrent').value),
                enable_websocket: document.getElementById('enableWebsocket').checked
            };

            debugLog('Starting avatar generation with ALL options', payload);

            loading.style.display = 'block';
            result.style.display = 'none';
            error.style.display = 'none';

            try {
                const startTime = Date.now();

                const response = await fetch(`/web/api/avatar_dual.php?action=generate&mode=${currentMode}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const duration = Date.now() - startTime;

                debugLog('Avatar API response received', {
                    status: response.status,
                    statusText: response.statusText,
                    ok: response.ok,
                    contentType: response.headers.get('content-type'),
                    duration: duration + 'ms',
                    headers: Object.fromEntries(response.headers.entries())
                });

                if (response.ok) {
                    const contentType = response.headers.get('content-type');

                    if (contentType && contentType.includes('video')) {
                        const blob = await response.blob();
                        const videoUrl = URL.createObjectURL(blob);

                        video.src = videoUrl;
                        result.style.display = 'block';

                        videoInfo.innerHTML = `
                            <strong>Generation Complete!</strong><br>
                            Mode: ${response.headers.get('x-avatar-mode') || currentMode}<br>
                            Engine: ${response.headers.get('x-avatar-engine') || 'unknown'}<br>
                            Voice: ${response.headers.get('x-avatar-voice') || 'unknown'}<br>
                            Size: ${blob.size} bytes<br>
                            Type: ${contentType}<br>
                            Generation Time: ${duration}ms<br>
                            Options Used: ${Object.keys(payload).length} parameters
                        `;

                        // Video event handlers
                        video.onloadeddata = () => {
                            debugLog('Video loaded successfully', {
                                duration: video.duration,
                                videoWidth: video.videoWidth,
                                videoHeight: video.videoHeight
                            });
                        };

                        video.onerror = (e) => {
                            debugLog('Video error', {
                                error: video.error,
                                code: video.error?.code,
                                message: video.error?.message
                            });
                        };

                        debugLog('Avatar generation successful', {
                            blobSize: blob.size,
                            blobType: blob.type,
                            parametersUsed: Object.keys(payload).length
                        });

                    } else {
                        const text = await response.text();
                        debugLog('Non-video response received', { response: text });
                        throw new Error('Expected video response, got: ' + contentType);
                    }
                } else {
                    const errorText = await response.text();
                    debugLog('Avatar generation failed', { status: response.status, error: errorText });
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }

            } catch (err) {
                debugLog('Avatar generation error', { error: err.message, stack: err.stack });
                error.textContent = 'Error: ' + err.message;
                error.style.display = 'block';
            } finally {
                loading.style.display = 'none';
            }
        }

        // Get TTS Engines
        async function getEngines() {
            debugLog('Getting TTS engines and voices');

            try {
                const response = await fetch('/web/api/avatar_dual.php?action=engines');
                const result = await response.json();

                if (result.engines) {
                    debugLog('TTS engines received', result.engines);
                    displayEngineInfo(result.engines);
                } else {
                    debugLog('No engine data received');
                }

            } catch (error) {
                debugLog('Engine retrieval error', { error: error.message });
            }
        }

        function displayEngineInfo(engines) {
            let info = "Available TTS Engines:\n\n";
            Object.entries(engines).forEach(([key, engine]) => {
                info += `${engine.name}:\n`;
                info += `  Voices: ${engine.voices.length}\n`;
                info += `  Speed Range: ${engine.speed_range[0]}-${engine.speed_range[1]}\n`;
                info += `  Pitch Range: ${engine.pitch_range[0]}-${engine.pitch_range[1]}\n\n`;
            });

            alert(info);
        }

        // Test functions
        async function testMP4() {
            debugLog('Testing MP4 pipeline');

            const video = document.getElementById('avatarVideo');
            const result = document.getElementById('result');
            const error = document.getElementById('error');

            try {
                const response = await fetch('/test-mp4');

                if (response.ok) {
                    const blob = await response.blob();
                    const videoUrl = URL.createObjectURL(blob);

                    video.src = videoUrl;
                    result.style.display = 'block';
                    error.style.display = 'none';

                    debugLog('Test MP4 loaded successfully', {
                        size: blob.size,
                        type: blob.type
                    });

                } else {
                    throw new Error(`Test MP4 failed: ${response.status}`);
                }

            } catch (err) {
                debugLog('Test MP4 failed', { error: err.message });
                error.textContent = 'Test MP4 Error: ' + err.message;
                error.style.display = 'block';
            }
        }

        async function testConnection() {
            debugLog('Testing avatar service connection');

            try {
                const response = await fetch('/web/api/avatar_dual.php?action=test');
                const result = await response.json();

                debugLog('Connection test result', result);

                if (result.status === 'success') {
                    alert('Connection successful: ' + result.message);
                } else {
                    alert('Connection failed: ' + result.message);
                }
            } catch (error) {
                debugLog('Connection test error', { error: error.message });
                alert('Connection test failed: ' + error.message);
            }
        }

        async function getServerInfo() {
            debugLog('Getting server connection info');

            try {
                const response = await fetch('/web/api/avatar_dual.php?action=server_info');
                const result = await response.json();

                debugLog('Server info received', result);
                displayServerInfo(result);

            } catch (error) {
                debugLog('Server info retrieval error', { error: error.message });
            }
        }

        function displayServerInfo(info) {
            const container = document.getElementById('serverInfo');

            if (!info || !info.current_peer) {
                container.innerHTML = '<div class="status-item status-error">No server info available</div>';
                return;
            }

            const peer = info.current_peer;
            const available = info.available_peers || [];

            let html = `
                <div class="status-item status-${peer.type === 'local' ? 'warning' : 'ok'}">
                    <strong>Current Avatar Server:</strong><br>
                    ${peer.name}<br>
                    Type: ${peer.type}<br>
                    ${peer.ip ? `IP: ${peer.ip}<br>` : ''}
                    ${peer.gpu_memory ? `GPU: ${peer.gpu_memory}GB<br>` : ''}
                    ${peer.memory ? `RAM: ${peer.memory}GB` : ''}
                </div>
            `;

            if (available.length > 0) {
                html += `
                    <div class="status-item status-ok">
                        <strong>Available Servers:</strong><br>
                        ${available.map(p => `${p.name} (${p.type})`).join('<br>')}
                    </div>
                `;
            }

            container.innerHTML = html;
        }

        async function getStatus() {
            debugLog('Getting system status');

            try {
                const response = await fetch('/web/api/avatar_dual.php?action=status');
                const result = await response.json();

                debugLog('System status received', result);
                displayStatus(result.data || result);

            } catch (error) {
                debugLog('Status retrieval error', { error: error.message });
            }
        }

        function displayStatus(status) {
            const grid = document.getElementById('statusGrid');

            if (!status) {
                grid.innerHTML = '<div class="status-item status-error">No status data available</div>';
                return;
            }

            const items = [
                { label: 'Timestamp', value: status.timestamp, status: 'ok' },
                { label: 'Device', value: status.device, status: 'ok' },
                { label: 'TTS Ready', value: status.tts_ready ? 'Yes' : 'No', status: status.tts_ready ? 'ok' : 'error' },
                { label: 'SadTalker Installed', value: status.sadtalker_installed ? 'Yes' : 'No', status: status.sadtalker_installed ? 'ok' : 'warning' },
                { label: 'Streaming Available', value: status.streaming_available ? 'Yes' : 'No', status: status.streaming_available ? 'ok' : 'warning' },
                { label: 'Default Codec', value: status.default_codec, status: 'ok' }
            ];

            grid.innerHTML = items.map(item => `
                <div class="status-item status-${item.status}">
                    <strong>${item.label}:</strong><br>
                    ${item.value}
                </div>
            `).join('');
        }

        async function getLogs() {
            debugLog('Getting avatar service logs');

            try {
                const response = await fetch('/web/api/avatar_dual.php?action=logs');
                const result = await response.json();

                debugLog('Logs received', { logCount: result.data?.logs?.length || 0 });

                const container = document.getElementById('logContainer');
                if (result.data && result.data.logs) {
                    container.innerHTML = result.data.logs.join('\n');
                } else {
                    container.innerHTML = 'No logs available';
                }

            } catch (error) {
                debugLog('Log retrieval error', { error: error.message });
            }
        }

        function refreshStatus() {
            getStatus();
        }

        function refreshLogs() {
            getLogs();
        }

        function clearLogs() {
            document.getElementById('logContainer').innerHTML = 'Logs cleared';
            debugLog('Debug logs cleared');
        }

        function clearDebugLogs() {
            document.getElementById('logContainer').innerHTML = 'Debug logs cleared';
            console.clear();
            debugLog('Debug console cleared');
        }

        function downloadLogs() {
            const logs = document.getElementById('logContainer').textContent;
            const blob = new Blob([logs], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `avatar_debug_logs_${new Date().toISOString()}.txt`;
            a.click();
            URL.revokeObjectURL(url);
            debugLog('Debug logs downloaded');
        }

        function copyLogsToClipboard() {
            const logs = document.getElementById('logContainer').textContent;
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(logs).then(() => {
                    debugLog('Debug logs copied to clipboard');
                    alert('Logs copied to clipboard!');
                }).catch(err => {
                    debugLog('Failed to copy logs to clipboard', { error: err.message });
                    alert('Failed to copy logs: ' + err.message);
                });
            }
        }

        // Initialize
        function initializeDebugConsole() {
            debugLog('Complete Avatar Debug Console initializing');

            // Set default TTS engine
            updateTTSOptions();

            // Initialize range displays
            updateRangeDisplay('speed', document.getElementById('ttsSpeed').value);
            updateRangeDisplay('pitch', document.getElementById('ttsPitch').value);

            // Load initial data
            getServerInfo();
            getStatus();

            debugLog('Initialization complete - ALL options loaded');
        }

        // Initialize when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeDebugConsole);
        } else {
            initializeDebugConsole();
        }
    </script>
</body>
</html>