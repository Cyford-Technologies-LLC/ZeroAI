#!/bin/bash
# Git wrapper that fixes permissions after operations

# Run the actual git command
/usr/bin/git "$@"
GIT_EXIT_CODE=$?

# Fix permissions after git operations - only for non-mounted directories
case "$1" in
    pull|checkout|reset|merge|rebase|clone)
        echo "Fixing permissions after git $1..."
        
        # Only fix permissions on directories that are NOT volume mounts
        # Skip /app/data, /app/knowledge, /app/backup as they are mounted volumes
        
        # Fix source code permissions (these are bind mounts, should be writable)
        find /app/src /app/API /app/run /app/scripts -type f -exec chmod 644 {} \; 2>/dev/null || true
        find /app/src /app/API /app/run /app/scripts -type d -exec chmod 755 {} \; 2>/dev/null || true
        
        echo "Permissions fixed."
        ;;
esac

exit $GIT_EXIT_CODE